<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.davizn.etcInterface.AlramDAO">



   <!-- 알람 개수 -->
   <select id="getCount" resultType="Integer">
      select count(*) from alarm
      where strgseq in (select strgseq from userstrg where userid=#{userid} and checkedstate=0)
   </select>

   <!-- 스케줄 알람 insert -->
   <insert id="scheduelAlarm">
      insert into alarm
      (alarmseq,DATANAME,DATASEQ,datatype,finaldate,alarmdate,checkedstate,strgseq)
      (select
      alarm_seq.nextval,p.DATANAME,s.DATASEQ,p.DATATYPE,s.finaldate,s.ALRAMDATE,0,p.STRGSEQ
      from personaldata p inner join schedule s on p.dataseq=s.dataseq where
      to_char(s.ALRAMDATE,'YYYY-MM-DD')=to_char(sysdate,'YYYY-MM-DD') and
      s.STATE=0)
   </insert>

   <!-- goal 알람 insert -->
   <insert id="goalAlarm">
      insert into alarm
      (alarmseq,DATANAME,DATASEQ,datatype,finaldate,alarmdate,checkedstate,strgseq)
      (select
      alarm_seq.nextval,p.dataname,g.DATASEQ,g.datatype,g.FINALDATE,g.FINALDATE,0,p.STRGSEQ
      from personaldata p inner join goal g on p.dataseq=g.dataseq where
      to_char(g.finaldate,'YYYY-MM-DD')=to_char(sysdate,'YYYY-MM-DD'))
   </insert>

   <!--header 알람 리스트 -->
   <select id="showAlarmList" resultType="kr.or.davizn.etcDTO.AlarmDTO">
      select dataname, datatype from alarm where strgseq in (select strgseq from userstrg where userid=#{userid}) and 
      (to_char(FINALDATE,'YYYY-MM-DD')=to_char(sysdate,'YYYY-MM-DD'))and(to_char(ALARMDATE,'YYYY-MM-DD')=to_char(sysdate,'YYYY-MM-DD')) 
      order by datatype asc
   </select>

</mapper>